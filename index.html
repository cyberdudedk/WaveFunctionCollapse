<html>
    <head>
        <style>
            table tr td:nth-child(2n-1) {
                width: 15%;

            }
            table tr td:nth-child(2n) {
                width: 10%;
                padding-right: 10px;
            }

            table input, table select {
                width: 100%;
            }

            table input[type="checkbox"] {
                width: auto;
            }

            canvas {
                border: 1px solid rgb(134, 132, 132);
            }
        </style>
        <script type="module" src="/dist/bundle.js"></script>
        <script>
            var wfcRender = {};
            var config = {
                    
            };

            function applyConfig() {
                const queryParams = new URLSearchParams(window.location.search);
                for(var configItem in config) {
                    var element = document.getElementById(configItem);
                    if(!element) continue;
                    if(element.type == 'checkbox') {
                        queryParams.set(configItem, element.checked ? 1 : 0);
                    }
                    else if(element.type == 'text') {
                        var value = element.value;
                        queryParams.set(configItem, value);
                    }
                    else if(configItem == "tileName" || configItem == "set") {
                        var value = element.value;
                        queryParams.set(configItem, value);
                    } else {
                        var value = parseInt(element.value);
                        var min = parseInt(element.min);
                        var max = parseInt(element.max);
                        if(element.min && value < min) {
                            value = min;
                        }
                        if(element.max && value > max) {
                            
                            value = max;
                        }
                        queryParams.set(configItem, value);
                    }
                }
                document.location = "?" + queryParams.toString();
            }

            function loadConfig() {
                const queryParams = new URLSearchParams(window.location.search);
                config.tileName = queryParams.get('tileName') ?? 'Knots';
                config.set = queryParams.get('set') ?? 'all';
                config.maxRetryCount = parseInt((queryParams.get('maxRetryCount') ?? 10));
                config.maxDepth =  parseInt((queryParams.get('maxDepth') ?? 100));
                config.tileScale =  parseInt((queryParams.get('tileScale') ?? 30));
                config.fast = parseInt((queryParams.get('fast') ?? 0));
                config.runSpeed = parseInt((queryParams.get('runSpeed') ?? 10));
                config.runLoop = parseInt((queryParams.get('runLoop') ?? 30));
                config.tilesHeight = parseInt((queryParams.get('tilesHeight') ?? 15));
                config.tilesWidth = parseInt((queryParams.get('tilesWidth') ?? 15));
                config.superImposed = parseInt((queryParams.get('superImposed') ?? 1));
                config.useMouse = parseInt((queryParams.get('useMouse') ?? 0));
                config.edgeWrapAround = parseInt((queryParams.get('edgeWrapAround') ?? 0));
                config.edgeSocket = queryParams.get('edgeSocket') ?? '';
                config.startingPosition = parseInt((queryParams.get('startingPosition') ?? 0));
                config.canvasHeight = parseInt((queryParams.get('canvasHeight') ?? 450));
                config.canvasWidth = parseInt((queryParams.get('canvasWidth') ?? 450));
                config.sizingMethod = parseInt((queryParams.get('sizingMethod') ?? 0));
                config.autoExpand = parseInt((queryParams.get('autoExpand') ?? 0));
                config.autoExpandSize = parseInt((queryParams.get('autoExpandSize') ?? 1));
            }

            function loadConfigControls(config) {
                dropDown("tileName", wfcRender.getAvailableTiles());
                dropDown("superImposed", wfcRender.getSuperImposedStates(), true);
                dropDown("startingPosition", wfcRender.getStartingPositions(), true);
                dropDown("sizingMethod", wfcRender.getSizingMethods(), true);

                for(var configItem in config) {
                    let element = document.getElementById(configItem);
                    if(!element) {
                        continue;
                    }
                    let type = element.type;
                    if(type == 'checkbox') {
                        document.getElementById(configItem).checked = config[configItem];
                    } else {
                        document.getElementById(configItem).value = config[configItem];
                    }
                }

                selectTile(document.getElementById('tileName'));
                document.getElementById('set').value = config['set'];
            }

            function dropDown(controlId, states, isEnum = false) {
                let selector = document.getElementById(controlId);
                for (var index in states){
                    let isValueProperty = (isEnum ? Number(index) >= 0 : true);
                    if (isValueProperty) {
                        let opt = document.createElement('option');
                        opt.value = (isEnum ? index : states[index]);
                        opt.innerHTML = states[index];
                        selector.appendChild(opt);
                    }
                }
            }

            function selectTile(obj) {
                var setSelector = document.getElementById("set");
                while (setSelector.options.length) setSelector.remove(0);

                dropDown("set", wfcRender.getAvailableSets(obj.value));
            }

            window.addEventListener("load", async function(){
                loadConfig();
                wfcRender = getWFCRender('draw');
                await wfcRender.init(config);
                loadConfigControls(config);

                await wfcRender.getWFC().initTileData();
                wfcRender.initDraw();
            });

            function saveImage() {
                downloadImage(wfcRender.getImage(), 'wfctile.png');
            }

            function downloadImage(data, filename = 'wfctile.png') {
                var a = document.createElement('a');
                a.href = data;
                a.download = filename;
                a.click();
            }
        </script>
    </head>
    <body style="background-color: rgba(249, 249, 249, 0.84);">
        <div>
            <h3>Controlpanel</h3>
            <div>
                <table>
                    <tbody>
                        <tr>
                            <td>tileName</td><td><select id="tileName" onchange="selectTile(this)"></select></td>
                            <td>set</td><td><select value="all" id="set"></select></td>
                            <td>superImposed</td><td><select id="superImposed"></select></td>
                        </tr>
                        <tr>
                            <td>tilesHeight</td><td><input type="number" min="0" max="200" id="tilesHeight"></td>
                            <td>tilesWidth</td><td><input type="number" min="0" max="200" id="tilesWidth"></td>
                            <td>tileScale</td><td><input type="number" min="1" max="200" id="tileScale"></td>
                        </tr>
                        <tr>
                            <td>runSpeed</td><td><input type="number" min="1" max="5000" id="runSpeed"></td>
                            <td>runLoop</td><td><input type="number" min="1" max="1000" id="runLoop"></td>
                            <td>fast</td><td><input type="checkbox" id="fast" value="fast"></td>
                        </tr>
                        <tr>
                            <td>maxRetryCount</td><td><input type="number" min="0" max="100" id="maxRetryCount"></td>
                            <td>maxDepth</td><td><input type="number" min="1" max="500" id="maxDepth"></td>
                            <td>useMouse</td><td><input type="checkbox" id="useMouse" value="useMouse"></td>
                        </tr>
                        <tr>
                            <td>edgeWrapAround</td><td><input type="checkbox" id="edgeWrapAround" value="edgeWrapAround"></td>
                            <td>edgeSocket</td><td><input type="text" id="edgeSocket" value="edgeSocket"></td>
                            <td>startingPosition<td><select id="startingPosition"></select></td>
                        </tr>
                        <tr>
                            <td>canvasHeight</td><td><input type="number" min="0" max="2000" id="canvasHeight"></td>
                            <td>canvasWidth</td><td><input type="number" min="0" max="2000" id="canvasWidth"></td>
                            <td>sizingMethod</td><td><select id="sizingMethod"></select></td>
                        </tr>
                        <tr>
                            <td>autoExpandSize</td><td><input type="number" min="1" max="100" id="autoExpandSize"></td>
                            <td>autoExpand</td><td><input type="checkbox" id="autoExpand" value="autoExpand"></td>
                            <td><button id="apply" onclick="applyConfig()">Apply</button></td><td><button id="save" onclick="saveImage()" >Save</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <br>
        <canvas id="draw">
        </canvas>
    </body>
</html>