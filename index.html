<html>
    <head>
        <style>
            table tr td:nth-child(2n-1) {
                width: 15%;

            }
            table tr td:nth-child(2n) {
                width: 10%;
                padding-right: 10px;
            }

            table input, table select {
                width: 100%;
            }

            table input[type="checkbox"] {
                width: auto;
            }

            canvas {
                border: 1px solid rgb(134, 132, 132);
            }
        </style>
        <script type="module" src="/dist/bundle.js"></script>
        <script>
            var wfcRender = {};
            var config = {};
            var renderConfig1 = {};
            var renderConfig2 = {};
            var renderConfig3 = {};

            function applyConfig() {
                const queryParams = new URLSearchParams(window.location.search);
                applyConfigs(queryParams, config, '');
                applyConfigs(queryParams, renderConfig1, 'render1_');
                applyConfigs(queryParams, renderConfig2, 'render2_');
                applyConfigs(queryParams, renderConfig3, 'render3_');
                document.location = "?" + queryParams.toString();
            }

            function applyConfigs(queryParams, config, prefix) {
                for(var configItem in config) {
                    let configName = prefix + configItem;
                    var element = document.getElementById(configName);
                    if(!element) continue;
                    if(element.type == 'checkbox') {
                        queryParams.set(configName, element.checked ? 1 : 0);
                    }
                    else if(element.type == 'text') {
                        var value = element.value;
                        queryParams.set(configName, value);
                    }
                    else if(configItem == "tileName" || configItem == "set") {
                        var value = element.value;
                        queryParams.set(configName, value);
                    } else {
                        var value = parseInt(element.value);
                        var min = parseInt(element.min);
                        var max = parseInt(element.max);
                        if(element.min && value < min) {
                            value = min;
                        }
                        if(element.max && value > max) {
                            
                            value = max;
                        }
                        queryParams.set(configName, value);
                    }
                }
            }

            function loadConfig() {
                const queryParams = new URLSearchParams(window.location.search);
                config.tileName = queryParams.get('tileName') ?? 'Knots';
                config.set = queryParams.get('set') ?? 'all';
                config.maxRetryCount = parseInt((queryParams.get('maxRetryCount') ?? 10));
                config.maxDepth =  parseInt((queryParams.get('maxDepth') ?? 100));
                config.tileScale =  parseInt((queryParams.get('tileScale') ?? 30));
                config.fast = parseInt((queryParams.get('fast') ?? 0));
                config.runSpeed = parseInt((queryParams.get('runSpeed') ?? 10));
                config.runLoop = parseInt((queryParams.get('runLoop') ?? 30));
                config.tilesHeight = parseInt((queryParams.get('tilesHeight') ?? 15));
                config.tilesWidth = parseInt((queryParams.get('tilesWidth') ?? 15));
                //config.superImposed = parseInt((queryParams.get('superImposed') ?? 1));
                config.useMouse = parseInt((queryParams.get('useMouse') ?? 0));
                config.edgeWrapAround = parseInt((queryParams.get('edgeWrapAround') ?? 0));
                config.edgeSocket = queryParams.get('edgeSocket') ?? '';
                config.startingPosition = parseInt((queryParams.get('startingPosition') ?? 0));
                config.canvasHeight = parseInt((queryParams.get('canvasHeight') ?? 450));
                config.canvasWidth = parseInt((queryParams.get('canvasWidth') ?? 450));
                config.sizingMethod = parseInt((queryParams.get('sizingMethod') ?? 0));
                config.autoExpand = parseInt((queryParams.get('autoExpand') ?? 0));
                config.autoExpandSize = parseInt((queryParams.get('autoExpandSize') ?? 1));
                config.neighborDistance = parseInt((queryParams.get('neighborDistance') ?? 1));
                config.gridSize = parseInt((queryParams.get('gridSize') ?? 0));
                config.runMethod = parseInt((queryParams.get('runMethod') ?? 0));

                renderConfig1.superImposed = parseInt((queryParams.get('render1_superImposed') ?? 1));
                renderConfig1.renderType = parseInt((queryParams.get('render1_renderType') ?? 1));

                renderConfig2.superImposed = parseInt((queryParams.get('render2_superImposed') ?? 1));
                renderConfig2.renderType = parseInt((queryParams.get('render2_renderType') ?? 1));

                renderConfig3.superImposed = parseInt((queryParams.get('render3_superImposed') ?? 1));
                renderConfig3.renderType = parseInt((queryParams.get('render3_renderType') ?? 1));
            }

            function loadConfigControls(config) {
                dropDown("tileName", wfcRender.getAvailableTiles());
                dropDown("render1_superImposed", wfcRender.getSuperImposedStates(), true);
                dropDown("render2_superImposed", wfcRender.getSuperImposedStates(), true);
                dropDown("render3_superImposed", wfcRender.getSuperImposedStates(), true);
                dropDown("render1_renderType", wfcRender.getRenderTypes(), true);
                dropDown("render2_renderType", wfcRender.getRenderTypes(), true);
                dropDown("render3_renderType", wfcRender.getRenderTypes(), true);
                dropDown("startingPosition", wfcRender.getStartingPositions(), true);
                dropDown("sizingMethod", wfcRender.getSizingMethods(), true);
                dropDown("runMethod", wfcRender.getRunMethods(), true);

                loadConfigControlsSetElements(config, '');
                loadConfigControlsSetElements(renderConfig1, 'render1_');
                loadConfigControlsSetElements(renderConfig2, 'render2_');
                loadConfigControlsSetElements(renderConfig3, 'render3_');

                selectTile(document.getElementById('tileName'));
                document.getElementById('set').value = config['set'];
            }

            function loadConfigControlsSetElements(config, prefix) {
                for(var configItem in config) {
                    let configName = prefix + configItem;
                    let element = document.getElementById(configName);
                    if(!element) {
                        continue;
                    }
                    let type = element.type;
                    if(type == 'checkbox') {
                        document.getElementById(configName).checked = config[configItem];
                    } else {
                        document.getElementById(configName).value = config[configItem];
                    }
                }
            }

            function dropDown(controlId, states, isEnum = false) {
                let selector = document.getElementById(controlId);
                for (var index in states){
                    let isValueProperty = (isEnum ? Number(index) >= 0 : true);
                    if (isValueProperty) {
                        let opt = document.createElement('option');
                        opt.value = (isEnum ? index : states[index]);
                        opt.innerHTML = states[index];
                        selector.appendChild(opt);
                    }
                }
            }

            function selectTile(obj) {
                var setSelector = document.getElementById("set");
                while (setSelector.options.length) setSelector.remove(0);

                dropDown("set", wfcRender.getAvailableSets(obj.value));
            }

            window.addEventListener("load", async function(){
                //console.clear();
                loadConfig();
                
                wfcRender = getWFCRender('draw');
                wfcRender2 = getWFCRender('draw2');
                wfcRender3 = getWFCRender('draw3');
                wfcRenderText = getWFCTextRender('textrender');

                this.wfc = getWFC();
                this.wfc.init(config);

                this.wfcRunner = getWFCRunner(config, this.wfc);
                this.wfcRunner.addCallback(this.wfcCallback);
                
                await wfcRender.init(config, renderConfig1, this.wfc, this.wfcRunner);
                await wfcRender2.init(config, renderConfig2, this.wfc, this.wfcRunner);
                await wfcRender3.init(config, renderConfig3, this.wfc, this.wfcRunner);
                await wfcRenderText.init(config, this.wfc, this.wfcRunner);
                
                await wfcRender.initImageData();
                await wfcRender2.initImageData();
                await wfcRender3.initImageData();
                
                loadConfigControls(config);
                
                await this.wfc.initTileData();
                wfcRunner.reset();
            });

            var waitingContinueForExpand = false;


            function autoExpand() {
                this.wfcRunner.expand();
                this.wfcRender.expand();
                this.wfcRender2.expand();
                this.wfcRender3.expand();
            }

            function wfcCallback(event) {
                if(event.type == 'found' && this.config.autoExpand) {
                    if(this.config.runMethod == 3) { //RunMethod.UntilExpand
                        this.waitingContinueForExpand = true;
                        return false;
                    } else {
                        autoExpand();
                        return true;
                    }
                    
                }
                else {
                    return false;
                }
            };


            function saveImage() {
                downloadImage(wfcRender.getImage(), 'wfctile.png');
            }

            function downloadImage(data, filename = 'wfctile.png') {
                var a = document.createElement('a');
                a.href = data;
                a.download = filename;
                a.click();
            }

            function continueRun() {
                if(waitingContinueForExpand) {
                    waitingContinueForExpand = false;
                    autoExpand();
                }
                this.wfcRunner.continueRun();
            }
        </script>
    </head>
    <body style="background-color: rgba(249, 249, 249, 0.84);">
        <div>
            <h3>Controlpanel</h3>
            <div>
                <table>
                    <tbody>
                        <tr>
                            <td>tileName</td><td><select id="tileName" onchange="selectTile(this)"></select></td>
                            <td>set</td><td><select value="all" id="set"></select></td>
                            <td></td><td></td>
                        </tr>
                        <tr>
                            <td>tilesHeight</td><td><input type="number" min="0" max="200" id="tilesHeight"></td>
                            <td>tilesWidth</td><td><input type="number" min="0" max="200" id="tilesWidth"></td>
                            <td>tileScale</td><td><input type="number" min="1" max="200" id="tileScale"></td>
                        </tr>
                        <tr>
                            <td>runSpeed</td><td><input type="number" min="1" max="5000" id="runSpeed"></td>
                            <td>runLoop</td><td><input type="number" min="1" max="1000" id="runLoop"></td>
                            <td>fast</td><td><input type="checkbox" id="fast" value="fast"></td>
                        </tr>
                        <tr>
                            <td>maxRetryCount</td><td><input type="number" min="0" max="100" id="maxRetryCount"></td>
                            <td>maxDepth</td><td><input type="number" min="0" max="500" id="maxDepth"></td>
                            <td>useMouse</td><td><input type="checkbox" id="useMouse" value="useMouse"></td>
                        </tr>
                        <tr>
                            <td>edgeWrapAround</td><td><input type="checkbox" id="edgeWrapAround" value="edgeWrapAround"></td>
                            <td>edgeSocket</td><td><input type="text" id="edgeSocket" value="edgeSocket"></td>
                            <td>startingPosition<td><select id="startingPosition"></select></td>
                        </tr>
                        <tr>
                            <td>canvasHeight</td><td><input type="number" min="0" max="2000" id="canvasHeight"></td>
                            <td>canvasWidth</td><td><input type="number" min="0" max="2000" id="canvasWidth"></td>
                            <td>sizingMethod</td><td><select id="sizingMethod"></select></td>
                        </tr>
                        <tr>
                            <td>autoExpandSize</td><td><input type="number" min="1" max="100" id="autoExpandSize"></td>
                            <td>autoExpand</td><td><input type="checkbox" id="autoExpand" value="autoExpand"></td>
                            <td>runMethod</td><td><select id="runMethod"></select></td>
                        </tr>
                        <tr>
                            <td>R1 renderType</td><td><select id="render1_renderType"></select></td>
                            <td>R1 superImposed</td><td><select id="render1_superImposed"></select></td>
<                            <td>Neighbor dist.</td><td><input type="number" min="1" max="100" id="neighborDistance"></td>
                        </tr>
                        <tr>
                            <td>R2 renderType</td><td><select id="render2_renderType"></select></td>
                            <td>R2 superImposed</td><td><select id="render2_superImposed"></select></td>
                            <td>Gridsize</td><td><input type="number" min="0" max="100" value="0" id="gridSize"></td>
                        </tr>
                        <tr>
                            <td>R3 renderType</td><td><select id="render3_renderType"></select></td>
                            <td>R3 superImposed</td><td><select id="render3_superImposed"></select></td>
                        </tr>
                        <tr>
                            <td><button id="apply" onclick="applyConfig()">Apply</button></td>
                            <td><button id="save" onclick="saveImage()" >Save</button></td>
                            <td><button id="continue" onclick="continueRun()" >Continue</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <br>

        <canvas id="draw">
        </canvas>
        <canvas id="draw2">
        </canvas>
        <canvas id="draw3">
        </canvas>
        <br>
        <div id="textrender" style="overflow-y: scroll;">
        </div>
     
        
        <!--<textarea id="log" rows="10" cols="100" style="width: 100%;"></textarea>-->
    </body>
</html>